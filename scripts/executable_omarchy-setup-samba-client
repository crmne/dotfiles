#!/bin/bash

set -euo pipefail

NUC_CREDENTIALS_FILE="/etc/samba/credentials-nuc"
HA_CREDENTIALS_FILE="/etc/samba/credentials-home-assistant"
FSTAB_FILE="/etc/fstab"
BEGIN_MARKER="# >>> omarchy samba shares >>>"
END_MARKER="# <<< omarchy samba shares <<<"

DEFAULT_UID="$(id -u)"
DEFAULT_GID="$(id -g)"

SHARES=(
  "//nuc.local/Documents|/mnt/nuc/documents|$NUC_CREDENTIALS_FILE"
  "//nuc.local/Games|/mnt/nuc/games|$NUC_CREDENTIALS_FILE"
  "//nuc.local/Music|/mnt/nuc/music|$NUC_CREDENTIALS_FILE"
  "//nuc.local/Music\\040Production|/mnt/nuc/music-production|$NUC_CREDENTIALS_FILE"
  "//nuc.local/Photos|/mnt/nuc/photos|$NUC_CREDENTIALS_FILE"
  "//nuc.local/Video\\040Editing|/mnt/nuc/video-editing|$NUC_CREDENTIALS_FILE"
  "//nuc.local/Videos|/mnt/nuc/videos|$NUC_CREDENTIALS_FILE"
  "//nuc.local/files|/mnt/nuc/files|$NUC_CREDENTIALS_FILE"
  "//homeassistant.local/config|/mnt/home-assistant/config|$HA_CREDENTIALS_FILE"
)

require_cmd() {
  command -v "$1" >/dev/null 2>&1
}

install_deps() {
  if require_cmd omarchy-pkg-add; then
    omarchy-pkg-add cifs-utils
    return
  fi

  if require_cmd pacman; then
    sudo pacman -S --noconfirm --needed cifs-utils
    return
  fi

  echo "❌ Couldn't find omarchy-pkg-add or pacman. Install cifs-utils manually and rerun."
  exit 1
}

prompt_user() {
  local default_user="$1"
  local header="$2"

  if require_cmd gum; then
    gum input --value "$default_user" --header "$header"
  else
    read -r -p "$header [$default_user]: " input_user
    echo "${input_user:-$default_user}"
  fi
}

prompt_password() {
  local header="$1"

  if require_cmd gum; then
    gum input --password --header "$header"
  else
    read -r -s -p "$header: " input_pass
    echo
    echo "$input_pass"
  fi
}

confirm_or_exit() {
  local nuc_username="$1"
  local ha_username="$2"

  if require_cmd gum; then
    gum style \
      --border normal \
      --padding "1 2" \
      --margin "1" \
      --align left \
      --bold \
      "Samba Client Setup" \
      "" \
      "Shares:    ${#SHARES[@]}" \
      "NUC user:  $nuc_username" \
      "HA user:   $ha_username" \
      "UID/GID:   $DEFAULT_UID/$DEFAULT_GID" \
      "NUC cred:  $NUC_CREDENTIALS_FILE" \
      "HA cred:   $HA_CREDENTIALS_FILE" \
      "Fstab:     $FSTAB_FILE"

    echo
    gum confirm "Proceed with Samba client setup?" || exit 1
  fi
}

write_credentials() {
  local credentials_file="$1"
  local username="$2"
  local password="$3"
  local tmp

  tmp=$(mktemp)
  chmod 600 "$tmp"

  cat >"$tmp" <<EOF_CRED
username=$username
password=$password
EOF_CRED

  sudo install -D -m 600 "$tmp" "$credentials_file"
  rm -f "$tmp"
}

create_mount_dirs() {
  local entry share mountpoint credentials_file

  for entry in "${SHARES[@]}"; do
    IFS='|' read -r share mountpoint credentials_file <<<"$entry"
    sudo mkdir -p "$mountpoint"
  done
}

render_fstab_block() {
  local entry share mountpoint credentials_file

  echo "$BEGIN_MARKER"
  for entry in "${SHARES[@]}"; do
    IFS='|' read -r share mountpoint credentials_file <<<"$entry"
    echo "$share $mountpoint cifs credentials=$credentials_file,uid=$DEFAULT_UID,gid=$DEFAULT_GID,file_mode=0755,dir_mode=0755,nofail,x-systemd.automount 0 0"
  done
  echo "$END_MARKER"
}

update_fstab() {
  local tmp_block tmp_out backup

  tmp_block=$(mktemp)
  tmp_out=$(mktemp)
  backup="${FSTAB_FILE}.bak.$(date +%Y%m%d-%H%M%S)"

  render_fstab_block > "$tmp_block"
  sudo cp "$FSTAB_FILE" "$backup"

  if grep -Fq "$BEGIN_MARKER" "$FSTAB_FILE"; then
    awk -v begin="$BEGIN_MARKER" -v end="$END_MARKER" -v block_file="$tmp_block" '
      BEGIN {
        while ((getline line < block_file) > 0) {
          block[++block_count] = line
        }
      }
      $0 == begin {
        for (i = 1; i <= block_count; i++) {
          print block[i]
        }
        in_block = 1
        next
      }
      $0 == end {
        in_block = 0
        next
      }
      !in_block {
        print
      }
    ' "$FSTAB_FILE" > "$tmp_out"
  else
    cat "$FSTAB_FILE" > "$tmp_out"
    echo >> "$tmp_out"
    cat "$tmp_block" >> "$tmp_out"
  fi

  sudo install -m 644 "$tmp_out" "$FSTAB_FILE"
  rm -f "$tmp_block" "$tmp_out"

  echo "Backup created: $backup"
}

validate_mounts() {
  if sudo mount -a -t cifs >/dev/null 2>&1; then
    echo "✅ Samba mounts validated with: mount -a -t cifs"
  else
    echo "⚠️ mount -a -t cifs reported an error."
    echo "   This can happen if the server is offline or credentials are incorrect."
    echo "   Your fstab and credentials are still configured."
  fi
}

main() {
  trap 'echo; echo "Setup cancelled by user"; exit 1' INT

  install_deps
  sudo -v

  local default_user nuc_username nuc_password ha_username ha_password
  default_user="$USER"

  nuc_username="$(prompt_user "$default_user" "NUC Samba username")"
  if [ -z "$nuc_username" ]; then
    echo "❌ NUC username is required."
    exit 1
  fi

  nuc_password="$(prompt_password "NUC Samba password")"
  if [ -z "$nuc_password" ]; then
    echo "❌ NUC password is required."
    exit 1
  fi

  ha_username="$(prompt_user "$default_user" "Home Assistant Samba username")"
  if [ -z "$ha_username" ]; then
    echo "❌ Home Assistant username is required."
    exit 1
  fi

  ha_password="$(prompt_password "Home Assistant Samba password")"
  if [ -z "$ha_password" ]; then
    echo "❌ Home Assistant password is required."
    exit 1
  fi

  confirm_or_exit "$nuc_username" "$ha_username"

  write_credentials "$NUC_CREDENTIALS_FILE" "$nuc_username" "$nuc_password"
  write_credentials "$HA_CREDENTIALS_FILE" "$ha_username" "$ha_password"
  create_mount_dirs
  update_fstab
  validate_mounts

  echo
  echo "✅ Samba client setup complete."
  echo "   NUC credentials: $NUC_CREDENTIALS_FILE"
  echo "   Home Assistant credentials: $HA_CREDENTIALS_FILE"
  echo "   Shares added in /etc/fstab between:"
  echo "   $BEGIN_MARKER"
  echo "   $END_MARKER"
}

main "$@"
