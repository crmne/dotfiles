#!/usr/bin/env bash

set -euo pipefail

wallpaper_dir="${HOME}/Wallpapers"
topic_api_url="https://unsplash.com/napi/topics/wallpapers/photos?per_page=30&orientation=landscape"
topic_page_url="https://unsplash.com/t/wallpapers"
user_agent="Mozilla/5.0 (X11; Linux x86_64) random-unsplash-wallpaper/1.0"
use_existing_only=0

mkdir -p "${wallpaper_dir}"

usage() {
  cat <<'EOF'
Usage: random-unsplash-wallpaper [--existing]

  --existing, -e  Pick a random file from ~/Wallpapers and apply it.
EOF
}

get_ids_from_api() {
  curl -fsSL -A "${user_agent}" "${topic_api_url}" \
    | grep -oE '"id":"[A-Za-z0-9_-]+"' \
    | cut -d'"' -f4 \
    | sort -u
}

get_ids_from_topic_page() {
  curl -fsSL -A "${user_agent}" "${topic_page_url}" \
    | grep -oE '/photos/[A-Za-z0-9_-]+' \
    | sed 's|/photos/||' \
    | sort -u
}

set_wallpaper() {
  local image="$1"
  local current_background_link="${HOME}/.config/omarchy/current/background"

  if ! command -v swaybg >/dev/null 2>&1; then
    echo "swaybg is not installed; cannot apply wallpaper."
    return 1
  fi

  mkdir -p "$(dirname "${current_background_link}")"
  ln -sfn "${image}" "${current_background_link}"

  pkill -x swaybg >/dev/null 2>&1 || true
  if command -v uwsm-app >/dev/null 2>&1; then
    setsid uwsm-app -- swaybg -i "${current_background_link}" -m fill >/dev/null 2>&1 &
  else
    setsid swaybg -i "${current_background_link}" -m fill >/dev/null 2>&1 &
  fi

  sleep 0.2
  if ! pgrep -x swaybg >/dev/null 2>&1; then
    echo "Failed to start swaybg."
    return 1
  fi

  return 0
}

pick_existing_wallpaper() {
  find "${wallpaper_dir}" -maxdepth 1 -type f \
    \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \) \
    | shuf -n 1
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --existing|-e)
      use_existing_only=1
      shift
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

if [ "${use_existing_only}" -eq 1 ]; then
  output_file="$(pick_existing_wallpaper || true)"
  if [ -z "${output_file:-}" ]; then
    echo "No existing wallpapers found in ${wallpaper_dir}."
    exit 1
  fi

  if set_wallpaper "${output_file}"; then
    echo "Wallpaper updated from existing image: ${output_file}"
  else
    echo "Could not auto-apply existing wallpaper: ${output_file}"
    exit 1
  fi
  exit 0
fi

mapfile -t ids < <(get_ids_from_api || true)
if [ "${#ids[@]}" -eq 0 ]; then
  mapfile -t ids < <(get_ids_from_topic_page || true)
fi

if [ "${#ids[@]}" -eq 0 ]; then
  echo "Could not find wallpaper photo IDs on Unsplash."
  exit 1
fi

selected_id="$(printf '%s\n' "${ids[@]}" | shuf -n 1)"
timestamp="$(date +%Y%m%d-%H%M%S)"
output_file="${wallpaper_dir}/unsplash-${timestamp}-${selected_id}.jpg"
download_url="https://unsplash.com/photos/${selected_id}/download?force=true&w=3840&h=2160&fit=crop&crop=entropy"

curl -fL -A "${user_agent}" "${download_url}" -o "${output_file}"

if set_wallpaper "${output_file}"; then
  echo "Wallpaper updated: ${output_file}"
else
  echo "Downloaded wallpaper but could not auto-apply it: ${output_file}"
fi
